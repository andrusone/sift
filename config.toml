# config.toml
# Media intake: ffprobe facts -> classify -> rename -> move/copy into an "intake" structure.
# This config is intentionally explicit and boring.

[paths]
# Where new files arrive.
incoming = "/nas/plex/incoming"

# Where classified+renamed files are written.
outgoing_root = "/nas/plex/test"

# Where ffprobe JSON results are cached (speed + audit trail).
metadata_cache = "/nas/plex/.cache/ffprobe"

[io]
# "move" or "copy"
mode = "copy"
mkdirs = true
dedupe_on_collision = true

[ffprobe]
bin = "ffprobe"
args = ["-v", "error", "-show_streams", "-show_format", "-of", "json"]

[classification]
# How to decide "movies" vs "tv".
# - "sxe": treat files containing S##E## as TV; otherwise Movies (your preference)
# - "folder": use the first directory under incoming (movies|tv)  (legacy)
# - "guess": other heuristics (reserved)
media_type_strategy = "sxe"

# Regex used when media_type_strategy = "sxe"
# Matches common patterns like:
#   S01E02, s01e02, S1E2, S01.E02, S01_E02, etc.
tv_sxe_regex = "(?i)\\bs\\s*\\d{1,2}\\s*[._ -]?\\s*e\\s*\\d{1,3}\\b"

# Optional: if enabled, also treat "Season 01 Episode 02" patterns as TV.
enable_season_episode_words = true
tv_season_episode_regex = "(?i)\\bseason\\s*\\d{1,2}\\b.*\\bepisode\\s*\\d{1,3}\\b"

# Pick which streams to use.
video_stream_strategy = "best"
audio_stream_strategy = "best"

# Codec preference ordering for selecting "best audio" (first wins).
audio_codec_preference = ["eac3", "ac3", "aac", "dts", "truehd"]

# Mark these audio codecs/profiles as "problematic" (Tier 5 intent).
problem_audio_codecs = ["truehd"]
problem_audio_profile_regex = ["dts[- ]?hd", "dts[- ]?hd[ -]?ma"]

# HDR detection settings (best-effort via ffprobe fields).
hdr_color_transfer = ["smpte2084", "arib-std-b67"]
hdr_side_data_regex = ["dovi", "dolby vision", "hdr10\\+", "mastering display", "content light level"]

[naming]
# Naming templates.
# Tokens are interpreted by your script; keep them simple.
# Suggested token set:
#   {title} {year} {show} {season2} {episode2} {stem}
#   {res} {hdr} {vcodec_tag} {acodec_tag} {audio_tag} {flags}
#   {ext}
#
# IMPORTANT:
# - If you are not doing online metadata lookup, {title}/{year}/{show}/{season}/{episode}
#   may be missing for many files. Use fallback_to_stem = true to avoid "Unknown" names.
movie_template = "{title} ({year}) [{res}{hdr_sep}{hdr} {vcodec_tag} {audio_tag}{flags_sep}{flags}].{ext}"
tv_template    = "{show} - S{season2}E{episode2} [{res}{hdr_sep}{hdr} {vcodec_tag} {audio_tag}{flags_sep}{flags}].{ext}"

# Separators used only when the right-hand side is present
# NOTE: whitespace-only is intentional and should be allowed by the script.
hdr_sep = " "
flags_sep = " "

fallback_to_stem = true

# How to render codec tags
vcodec_map = { h264 = "H264", hevc = "HEVC", av1 = "AV1" }
acodec_map = { aac = "AAC", ac3 = "DD", eac3 = "DDP", dts = "DTS", truehd = "TRUEHD" }

sanitize = true
max_filename_len = 180

[tier_model]
tiers = 5

[[tier_model.tier]]
id = "T1"
folder = "T1-2160p-HDR-DDP5.1"
description = "Reference / top shelf. 2160p + HDR + HEVC/AV1 + DDP 5.1+."
requires = { res = ["2160p"], hdr = true, vcodec = ["hevc", "av1"], acodec = ["eac3"], min_audio_channels = 6 }
flags = ["REF", "KEEP"]

[[tier_model.tier]]
id = "T2"
folder = "T2-2160p-DD5.1"
description = "Excellent. 2160p + HEVC + DD/DDP 5.1+. HDR optional."
requires = { res = ["2160p"], vcodec = ["hevc"], acodec = ["ac3", "eac3"], min_audio_channels = 6 }
flags = ["KEEP"]

[[tier_model.tier]]
id = "T3"
folder = "T3-1080p-Good"
description = "Good / acceptable. 1080p + H264/HEVC + AAC/DD/DDP 2.0+."
requires = { res = ["1080p"], vcodec = ["h264", "hevc"], acodec = ["aac", "ac3", "eac3"], min_audio_channels = 2 }
flags = ["OK"]

[[tier_model.tier]]
id = "T4"
folder = "T4-LowQuality"
description = "Marginal. 720p/SD or generally suboptimal encodes."
requires = { res = ["720p", "SD"] }
flags = ["REPLACE_SOON"]

[[tier_model.tier]]
id = "T5"
folder = "T5-Incompatible"
description = "Problematic for Apple TV / direct play. TrueHD / DTS-HD MA, etc."
requires = { problem_audio = true }
flags = ["REPLACE", "INCOMPATIBLE"]

[flags]
enable_hfr_flag = true
hfr_fps_threshold = 50.0

enable_low_bitrate_flag = true
low_bitrate_thresholds = { "2160p" = 12000000, "1080p" = 3000000, "720p" = 1500000 }
low_bitrate_flag_name = "LOW_BR"

[reporting]
write_jsonl_report = true

# Keep reports under outgoing_root for consistency with your /nas/plex layout.
report_path = "/nas/plex/intake-report.jsonl"
